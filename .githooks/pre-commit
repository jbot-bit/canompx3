#!/usr/bin/env bash
#
# Pre-commit hook: blocks commit if guardrails fail.
# Runs in <10 seconds. Fail-closed.
#
# Setup: git config core.hooksPath .githooks
#

set -e

# Activate venv if present (for ruff/python/pytest)
# Try venv/ first (active dev environment), fall back to .venv/
# Save PATH before activate to prevent Git Bash utilities from disappearing
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
_SAVED_PATH="$PATH"
if [ -f "$SCRIPT_DIR/venv/Scripts/activate" ]; then
    source "$SCRIPT_DIR/venv/Scripts/activate" 2>/dev/null
elif [ -f "$SCRIPT_DIR/venv/bin/activate" ]; then
    source "$SCRIPT_DIR/venv/bin/activate" 2>/dev/null
elif [ -f "$SCRIPT_DIR/.venv/Scripts/activate" ]; then
    source "$SCRIPT_DIR/.venv/Scripts/activate" 2>/dev/null
elif [ -f "$SCRIPT_DIR/.venv/bin/activate" ]; then
    source "$SCRIPT_DIR/.venv/bin/activate" 2>/dev/null
fi
# Restore Git Bash utilities (tail, grep, etc.) that activate may have removed
export PATH="$PATH:$_SAVED_PATH"

echo "=== PRE-COMMIT CHECKS ==="
echo ""

# Resolve python — prefer venv/ (active dev env), fall back to .venv/
PYTHON="python"
if [ -f "$SCRIPT_DIR/venv/Scripts/python.exe" ]; then
    PYTHON="$SCRIPT_DIR/venv/Scripts/python.exe"
elif [ -f "$SCRIPT_DIR/venv/bin/python" ]; then
    PYTHON="$SCRIPT_DIR/venv/bin/python"
elif [ -f "$SCRIPT_DIR/.venv/Scripts/python.exe" ]; then
    PYTHON="$SCRIPT_DIR/.venv/Scripts/python.exe"
elif [ -f "$SCRIPT_DIR/.venv/bin/python" ]; then
    PYTHON="$SCRIPT_DIR/.venv/bin/python"
fi

# 0. Ruff lint check (~1 second)
echo "[0/3] Ruff lint..."
RUFF="ruff"
if [ -f "$SCRIPT_DIR/venv/Scripts/ruff.exe" ]; then
    RUFF="$SCRIPT_DIR/venv/Scripts/ruff.exe"
elif [ -f "$SCRIPT_DIR/.venv/Scripts/ruff.exe" ]; then
    RUFF="$SCRIPT_DIR/.venv/Scripts/ruff.exe"
fi
if ! "$RUFF" check pipeline/ trading_app/ > /dev/null 2>&1; then
    echo "BLOCKED: Lint errors detected."
    "$RUFF" check pipeline/ trading_app/
    exit 1
fi
echo "  PASSED"

# 1. Drift check (~2 seconds)
echo "[1/3] Drift check..."
if ! "$PYTHON" pipeline/check_drift.py > /dev/null 2>&1; then
    echo "BLOCKED: Drift detected."
    "$PYTHON" pipeline/check_drift.py
    exit 1
fi
echo "  PASSED"

# 2. Fast tests — all Tier 1 tests except slow integration/paper_trader
# Use -n 4 (not -n auto/32): reduces Windows resource pressure from parallel
# DuckDB imports and test I/O. Higher counts cause intermittent failures.
echo "[2/3] Fast tests..."
TEST_OUTPUT=$("$PYTHON" -m pytest "$SCRIPT_DIR/tests/" --ignore="$SCRIPT_DIR/tests/test_trader_logic.py" --ignore="$SCRIPT_DIR/tests/test_trading_app/test_integration.py" --ignore="$SCRIPT_DIR/tests/test_trading_app/test_paper_trader.py" --ignore="$SCRIPT_DIR/tests/test_tools/" -x -q -n 4 --dist loadscope 2>&1) || true
TEST_EXIT=${PIPESTATUS[0]:-$?}
echo "$TEST_OUTPUT" | tail -5
if [ "$TEST_EXIT" -ne 0 ]; then
    echo "BLOCKED: Tests failed."
    exit 1
fi

# 3. Syntax check on staged .py files
echo "[3/3] Syntax check..."
STAGED_PY=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)
if [ -n "$STAGED_PY" ]; then
    for f in $STAGED_PY; do
        "$PYTHON" -m py_compile "$f" 2>/dev/null
        if [ $? -ne 0 ]; then
            echo "BLOCKED: Syntax error in $f"
            "$PYTHON" -m py_compile "$f"
            exit 1
        fi
    done
    echo "  PASSED"
else
    echo "  No .py files staged"
fi

echo ""
echo "=== ALL PRE-COMMIT CHECKS PASSED ==="
